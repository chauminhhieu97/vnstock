<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VNStock Real-Time Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        @keyframes pulse-live {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .animate-pulse-live {
            animation: pulse-live 2s infinite;
        }

        @keyframes flash-up {
            0% {
                background-color: rgba(16, 185, 129, 0);
            }

            50% {
                background-color: rgba(16, 185, 129, 0.3);
            }

            100% {
                background-color: rgba(16, 185, 129, 0);
            }
        }

        @keyframes flash-down {
            0% {
                background-color: rgba(239, 68, 68, 0);
            }

            50% {
                background-color: rgba(239, 68, 68, 0.3);
            }

            100% {
                background-color: rgba(239, 68, 68, 0);
            }
        }

        .flash-up {
            animation: flash-up 0.5s ease-out;
        }

        .flash-down {
            animation: flash-down 0.5s ease-out;
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-slate-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 text-white shadow-2xl">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="p-2.5 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl shadow-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold tracking-tight">VNStock Real-Time</h1>
                        <p class="text-xs text-slate-400">D·ªØ li·ªáu ch·ª©ng kho√°n Vi·ªát Nam</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div id="connection-status"
                        class="flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold bg-amber-500/20 text-amber-400">
                        <div class="w-2 h-2 bg-amber-500 rounded-full"></div>
                        <span>ƒêang k·∫øt n·ªëi...</span>
                    </div>
                    <div id="last-update" class="text-xs text-slate-400"></div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
        <!-- Market Overview -->
        <div id="market-overview" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>

        <!-- Stats Cards -->
        <div id="market-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>

        <!-- Quant Signals Section -->
        <div class="mt-8 mb-6">
            <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2 mb-4">
                <span
                    class="w-8 h-8 flex items-center justify-center bg-indigo-500 rounded-lg text-white text-lg">‚ö°Ô∏è</span>
                T√≠n Hi·ªáu Giao D·ªãch (Quant)
            </h3>
            <div id="quant-signals" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div
                    class="col-span-full py-12 text-center text-slate-400 bg-slate-50 rounded-xl border border-dashed border-slate-200">
                    <svg class="w-8 h-8 mx-auto mb-2 opacity-50 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    ƒêang t√¨m ki·∫øm c∆° h·ªôi ƒë·∫ßu t∆∞...
                </div>
            </div>
        </div>

        <!-- Price Board -->
        <div class="bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden">
            <div class="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 p-4 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-white/10 rounded-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold">B·∫£ng Gi√° Real-Time</h2>
                            <p id="update-time" class="text-xs text-slate-400">ƒêang t·∫£i...</p>
                        </div>
                    </div>
                    <button onclick="fetchData()"
                        class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                        <svg id="refresh-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        L√†m m·ªõi
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="bg-slate-50 text-xs text-slate-500 uppercase tracking-wider">
                            <th class="px-4 py-3 text-left font-semibold">M√£ CK</th>
                            <th class="px-4 py-3 text-right font-semibold">Gi√°</th>
                            <th class="px-4 py-3 text-right font-semibold">+/-</th>
                            <th class="px-4 py-3 text-right font-semibold">%</th>
                            <th class="px-4 py-3 text-right font-semibold">Kh·ªëi l∆∞·ª£ng</th>
                            <th class="px-4 py-3 text-right font-semibold">Gi√° tr·ªã (t·ª∑)</th>
                            <th class="px-4 py-3 text-right font-semibold">NN Mua</th>
                            <th class="px-4 py-3 text-right font-semibold">NN B√°n</th>
                        </tr>
                    </thead>
                    <tbody id="price-table" class="divide-y divide-slate-100">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>

            <div id="footer-stats" class="bg-slate-50 px-4 py-3 border-t border-slate-100">
                <!-- Footer stats -->
            </div>
        </div>
    </main>

    <!-- Chart Modal -->
    <div id="chart-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/75 backdrop-blur-sm transition-opacity" onclick="closeChartModal()">
        </div>

        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div
                    class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                                <h3 class="text-xl font-semibold leading-6 text-slate-900 mb-4" id="modal-title">Bi·ªÉu ƒë·ªì
                                    k·ªπ thu·∫≠t</h3>
                                <div
                                    class="w-full bg-slate-50 rounded-lg overflow-hidden border border-slate-200 min-h-[400px] flex items-center justify-center relative">
                                    <div id="chart-loading"
                                        class="absolute inset-0 flex items-center justify-center bg-slate-50 z-10">
                                        <svg class="w-8 h-8 animate-spin text-indigo-500" fill="none"
                                            viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                                stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor"
                                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                            </path>
                                        </svg>
                                    </div>
                                    <img id="modal-chart-img" src="" alt="Technical Chart"
                                        class="w-full h-auto object-contain hidden"
                                        onload="document.getElementById('chart-loading').classList.add('hidden'); this.classList.remove('hidden');">
                                </div>
                                <p class="mt-2 text-sm text-slate-500">
                                    Bi·ªÉu ƒë·ªì bao g·ªìm ƒë∆∞·ªùng SMA 50 (Xanh) v√† EMA 200 (ƒê·ªè). N·∫øn nh·∫≠t.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                        <button type="button"
                            class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50 sm:mt-0 sm:w-auto"
                            onclick="closeChartModal()">ƒê√≥ng</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let ws = null;
        let previousPrices = {};

        // Format number with locale
        const formatNumber = (num) => num?.toLocaleString('vi-VN') || '0';
        const formatVolume = (vol) => {
            if (vol >= 1000000) return (vol / 1000000).toFixed(1) + 'M';
            if (vol >= 1000) return (vol / 1000).toFixed(0) + 'K';
            return vol?.toString() || '0';
        };

        // Get price color class
        const getPriceColor = (quote) => {
            if (quote.price >= quote.ceilingPrice) return 'text-purple-600 bg-purple-50';
            if (quote.price <= quote.floorPrice) return 'text-cyan-500 bg-cyan-50';
            if (quote.changePercent > 0) return 'text-emerald-600';
            if (quote.changePercent < 0) return 'text-red-500';
            return 'text-amber-500';
        };

        // Get change badge class
        const getChangeBadge = (changePercent) => {
            if (changePercent > 0) return 'bg-emerald-50 text-emerald-600';
            if (changePercent < 0) return 'bg-red-50 text-red-500';
            return 'bg-slate-100 text-slate-600';
        };

        // Update connection status
        const updateConnectionStatus = (connected) => {
            const el = document.getElementById('connection-status');
            if (connected) {
                el.className = 'flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold bg-emerald-500/20 text-emerald-400';
                el.innerHTML = `<div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse-live"></div><span>Live</span>`;
            } else {
                el.className = 'flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold bg-red-500/20 text-red-400';
                el.innerHTML = `<div class="w-2 h-2 bg-red-500 rounded-full"></div><span>Offline</span>`;
            }
        };

        // Render market overview
        const renderMarketOverview = (data) => {
            const container = document.getElementById('market-overview');

            const indices = [
                { name: 'VN-Index', data: data.vnindex, color: 'from-blue-500 to-indigo-600' },
                { name: 'HNX-Index', data: data.hnxindex, color: 'from-emerald-500 to-teal-600' },
                { name: 'UPCOM', data: data.upcomIndex, color: 'from-purple-500 to-pink-600' }
            ];

            container.innerHTML = indices.map(idx => `
                <div class="relative overflow-hidden rounded-2xl p-5 text-white bg-gradient-to-br ${idx.color} shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-[1.02] cursor-pointer">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium opacity-90">${idx.name}</span>
                            <div class="flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold ${idx.data.change >= 0 ? 'bg-white/20' : 'bg-black/20'}">
                                ${idx.data.change >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(idx.data.changePercent).toFixed(2)}%
                            </div>
                        </div>
                        <div class="text-3xl font-bold tracking-tight mb-1">${idx.data.value.toFixed(2)}</div>
                        <div class="flex items-center gap-2 text-sm opacity-80">
                            <span>${idx.data.change >= 0 ? '+' : ''}${idx.data.change.toFixed(2)} ƒëi·ªÉm</span>
                            <span>‚Ä¢</span>
                            <span>KL: ${formatVolume(idx.data.volume)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        // Render market stats
        const renderMarketStats = (data) => {
            const container = document.getElementById('market-stats');
            const total = data.advanceCount + data.declineCount + data.unchangedCount;
            const advPct = (data.advanceCount / total * 100).toFixed(0);
            const decPct = (data.declineCount / total * 100).toFixed(0);

            container.innerHTML = `
                <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
                    <div class="flex items-center gap-2 mb-3">
                        <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        <span class="text-xs font-semibold text-slate-500 uppercase">ƒê·ªô r·ªông TT</span>
                    </div>
                    <div class="flex h-2 bg-slate-100 rounded-full overflow-hidden mb-2">
                        <div class="bg-emerald-500" style="width: ${advPct}%"></div>
                        <div class="bg-red-500" style="width: ${decPct}%"></div>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-emerald-600 font-semibold">‚Üë ${data.advanceCount}</span>
                        <span class="text-slate-400">${data.unchangedCount}</span>
                        <span class="text-red-600 font-semibold">‚Üì ${data.declineCount}</span>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
                    <div class="flex items-center gap-2 mb-2">
                        <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2z"/>
                        </svg>
                        <span class="text-xs font-semibold text-slate-500 uppercase">Kh·ªëi l∆∞·ª£ng</span>
                    </div>
                    <div class="text-2xl font-bold text-slate-900">${formatVolume(data.totalVolume)}</div>
                    <p class="text-xs text-slate-400">c·ªï phi·∫øu</p>
                </div>
                
                <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
                    <div class="flex items-center gap-2 mb-2">
                        <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="text-xs font-semibold text-slate-500 uppercase">Gi√° tr·ªã GD</span>
                    </div>
                    <div class="text-2xl font-bold text-slate-900">${(data.totalValue / 1000).toFixed(1)}K</div>
                    <p class="text-xs text-slate-400">t·ª∑ ƒë·ªìng</p>
                </div>
                
                <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
                    <div class="flex items-center gap-2 mb-2">
                        <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                        </svg>
                        <span class="text-xs font-semibold text-slate-500 uppercase">NN Mua r√≤ng</span>
                    </div>
                    <div class="text-2xl font-bold ${data.foreignNetBuy >= 0 ? 'text-emerald-600' : 'text-red-600'}">
                        ${data.foreignNetBuy >= 0 ? '+' : ''}${data.foreignNetBuy.toFixed(0)}
                    </div>
                    <p class="text-xs text-slate-400">t·ª∑ ƒë·ªìng</p>
                </div>
            `;
        };

        // Render price table
        const renderPriceTable = (data) => {
            const tbody = document.getElementById('price-table');

            tbody.innerHTML = data.map(quote => {
                const prevPrice = previousPrices[quote.ticker];
                let flashClass = '';
                if (prevPrice && quote.price !== prevPrice) {
                    flashClass = quote.price > prevPrice ? 'flash-up' : 'flash-down';
                }
                previousPrices[quote.ticker] = quote.price;

                return `
                    <tr class="hover:bg-slate-50/80 transition-colors cursor-pointer ${flashClass}">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center font-bold text-sm ${quote.changePercent > 0 ? 'bg-emerald-50 text-emerald-600' :
                        quote.changePercent < 0 ? 'bg-red-50 text-red-600' :
                            'bg-amber-50 text-amber-600'
                    }">
                                    ${quote.ticker.slice(0, 3)}
                                </div>
                                <div>
                                    <div class="font-semibold text-slate-900">${quote.ticker}</div>
                                    <div class="text-xs text-slate-400">${quote.exchange}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-right">
                            <span class="mono font-bold ${getPriceColor(quote)} px-2 py-1 rounded">
                                ${formatNumber(quote.price)}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-right mono font-semibold ${quote.change >= 0 ? 'text-emerald-600' : 'text-red-500'}">
                            ${quote.change >= 0 ? '+' : ''}${formatNumber(quote.change)}
                        </td>
                        <td class="px-4 py-3 text-right">
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold ${getChangeBadge(quote.changePercent)}">
                                ${quote.changePercent >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(quote.changePercent).toFixed(2)}%
                            </span>
                        </td>
                        <td class="px-4 py-3 text-right mono font-medium text-slate-700">
                            ${formatVolume(quote.volume)}
                        </td>
                        <td class="px-4 py-3 text-right mono font-medium text-slate-600">
                            ${quote.totalValue.toFixed(1)}
                        </td>
                        <td class="px-4 py-3 text-right mono text-emerald-600">
                            ${formatVolume(quote.foreignBuy)}
                        </td>
                        <td class="px-4 py-3 text-right mono text-red-500">
                            ${formatVolume(quote.foreignSell)}
                        </td>
                    </tr>
                `;
            }).join('');

            // Update footer
            const footer = document.getElementById('footer-stats');
            const advance = data.filter(q => q.changePercent > 0).length;
            const decline = data.filter(q => q.changePercent < 0).length;
            const unchanged = data.length - advance - decline;
            const totalVol = data.reduce((s, q) => s + q.volume, 0);

            footer.innerHTML = `
                <div class="flex items-center justify-between text-xs text-slate-500">
                    <div class="flex items-center gap-4">
                        <span class="flex items-center gap-1">
                            <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                            TƒÉng: ${advance}
                        </span>
                        <span class="flex items-center gap-1">
                            <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                            Gi·∫£m: ${decline}
                        </span>
                        <span class="flex items-center gap-1">
                            <div class="w-2 h-2 bg-amber-500 rounded-full"></div>
                            ƒê·ª©ng: ${unchanged}
                        </span>
                    </div>
                    <div>T·ªïng: ${data.length} m√£ | KL: ${formatVolume(totalVol)}</div>
                </div>
            `;
        };

        // Fetch data from API
        const fetchData = async () => {
            const refreshIcon = document.getElementById('refresh-icon');
            refreshIcon.classList.add('animate-spin');

            try {
                // Fetch market overview
                const marketRes = await fetch(`${API_BASE}/api/market`);
                const marketData = await marketRes.json();
                renderMarketOverview(marketData);
                renderMarketStats(marketData);

                // Fetch price board
                const priceRes = await fetch(`${API_BASE}/api/price-board`);
                const priceData = await priceRes.json();
                renderPriceTable(priceData.data);

                // Update time
                const now = new Date();
                document.getElementById('update-time').textContent = `C·∫≠p nh·∫≠t: ${now.toLocaleTimeString('vi-VN')}`;
                document.getElementById('last-update').textContent = now.toLocaleTimeString('vi-VN');

                updateConnectionStatus(true);
            } catch (error) {
                console.error('Fetch error:', error);
                updateConnectionStatus(false);
            }

            refreshIcon.classList.remove('animate-spin');
        };

        // Connect WebSocket
        const connectWebSocket = () => {
            ws = new WebSocket('ws://localhost:8000/ws');

            ws.onopen = () => {
                console.log('WebSocket connected');
                updateConnectionStatus(true);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.data && Array.isArray(data.data)) {
                    renderPriceTable(data.data);
                    const now = new Date();
                    document.getElementById('update-time').textContent = `C·∫≠p nh·∫≠t: ${now.toLocaleTimeString('vi-VN')}`;
                }
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
                // Reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        };

        // Initialize
        fetchData();
        fetchQuantSignals();
        connectWebSocket();

        // Auto refresh every 30 seconds if WS fails
        setInterval(fetchData, 30000);
        // Refresh signals every 5 minutes
        setInterval(fetchQuantSignals, 300000);

        // --- QUANT SIGNALS LOGIC ---
        async function fetchQuantSignals() {
            try {
                const response = await fetch(`${API_BASE}/api/screener/quant?limit=25`);
                const data = await response.json();
                renderQuantSignals(data.data);
            } catch (error) {
                console.error('Error fetching quant signals:', error);
                document.getElementById('quant-signals').innerHTML = `
                    <div class="col-span-full py-8 text-center text-red-400 bg-red-50 rounded-xl border border-red-100">
                        Kh√¥ng th·ªÉ t·∫£i t√≠n hi·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.
                    </div>
                `;
            }
        }

        function renderQuantSignals(signals) {
            const container = document.getElementById('quant-signals');

            if (!signals || signals.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full py-12 text-center text-slate-400 bg-slate-50 rounded-xl border border-dashed border-slate-200">
                        Kh√¥ng t√¨m th·∫•y t√≠n hi·ªáu ph√π h·ª£p trong phi√™n n√†y.
                    </div>
                `;
                return;
            }

            container.innerHTML = signals.map(signal => {
                // Determine signal type style
                let signalClass = 'bg-slate-100 text-slate-600';
                let signalIcon = '';

                if (signal.signal.includes('BUY')) {
                    signalClass = signal.signal.includes('STRONG')
                        ? 'bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg shadow-emerald-200'
                        : 'bg-emerald-100 text-emerald-700 border border-emerald-200';
                    signalIcon = 'üöÄ';
                } else if (signal.signal.includes('SELL')) {
                    signalClass = 'bg-red-100 text-red-700 border border-red-200';
                    signalIcon = '‚ö†Ô∏è';
                } else {
                    signalClass = 'bg-amber-100 text-amber-700 border border-amber-200';
                    signalIcon = 'üëÄ';
                }

                return `
                <div class="bg-white rounded-xl p-5 shadow-sm hover:shadow-md transition-shadow border border-slate-100 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-slate-50 to-white rounded-bl-full -mr-4 -mt-4 opacity-50 group-hover:scale-110 transition-transform"></div>
                    
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-2xl font-bold text-slate-800 tracking-tight flex items-center gap-2">
                                    ${signal.symbol}
                                    ${signal.total_score ? `
                                    <span class="text-xs ${signal.total_score >= 80 ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-600'} px-2 py-0.5 rounded-full font-extrabold border border-current/10">
                                        ${signal.total_score}/100
                                    </span>` : ''}
                                </h4>
                                <span class="text-xs text-slate-400 font-medium">HOSE</span>
                            </div>
                            <span class="px-3 py-1 rounded-lg text-xs font-bold tracking-wide flex items-center gap-1 ${signalClass}">
                                ${signalIcon} ${signal.signal}
                            </span>
                        </div>
                        
                        <div class="space-y-3 mb-4">
                            <div class="flex items-center gap-2 text-sm">
                                <span class="w-20 text-slate-400">M·∫´u h√¨nh</span>
                                <span class="font-medium text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded text-xs select-none truncate max-w-[140px]">
                                    ${signal.pattern || 'N/A'}
                                </span>
                            </div>
                            <div class="flex items-center gap-2 text-sm">
                                <span class="w-20 text-slate-400">P/E</span>
                                <span class="font-medium text-slate-700">${signal.pe ? signal.pe.toFixed(1) : '-'}</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm">
                                <span class="w-20 text-slate-400">ROE</span>
                                <span class="font-medium text-slate-700">${signal.roe ? (signal.roe * 100).toFixed(1) + '%' : '-'}</span>
                            </div>
                        </div>

                        ${signal.cfo_vs_ni ? `
                        <div class="mt-3 pt-3 border-t border-slate-50">
                            <div class="flex justify-between text-xs items-center mb-2">
                                <span class="text-slate-400">Ch·∫•t l∆∞·ª£ng FA</span>
                                <span class="text-purple-600 font-semibold bg-purple-50 px-2 py-0.5 rounded">
                                    ${signal.cfo_vs_ni}
                                </span>
                            </div>
                        </div>` : ''}
                        
                        ${signal.chart_url ? `
                        <button onclick="showChart('${API_BASE}${signal.chart_url}', '${signal.symbol} - ${signal.pattern}')" class="w-full mt-2 py-2 flex items-center justify-center gap-2 text-sm font-semibold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors border border-indigo-100">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            Xem Bi·ªÉu ƒê·ªì
                        </button>` : ''}
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- CHART MODAL LOGIC ---
        function showChart(url, title) {
            const modal = document.getElementById('chart-modal');
            const img = document.getElementById('modal-chart-img');
            const titleEl = document.getElementById('modal-title');
            const loader = document.getElementById('chart-loading');

            titleEl.textContent = title;
            img.src = url;
            img.classList.add('hidden');
            loader.classList.remove('hidden');

            modal.classList.remove('hidden');
        }

        function closeChartModal() {
            const modal = document.getElementById('chart-modal');
            modal.classList.add('hidden');
            document.getElementById('modal-chart-img').src = '';
        }

        // Auto refresh every 30 seconds if WS fails
        setInterval(fetchData, 30000);
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VNStock AI Screener (VN100)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        @keyframes pulse-live {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .animate-pulse-live {
            animation: pulse-live 2s infinite;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen text-slate-800">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-indigo-600 rounded-lg text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold tracking-tight text-slate-900">VNStock <span
                                class="text-indigo-600">AI Screener</span></h1>
                        <p class="text-xs text-slate-500">Ph√¢n t√≠ch chuy√™n s√¢u 100 m√£ VN100 (VN30 + Midcap)</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div id="connection-status"
                        class="flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-400">
                        <div class="w-2 h-2 bg-slate-400 rounded-full"></div>
                        <span>Ch·ªù k·∫øt n·ªëi...</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
        <!-- Unified AI Table -->
        <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
            <div
                class="p-6 border-b border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-4 bg-slate-50/50">
                <div>
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <span class="text-2xl">ü§ñ</span> B·∫£ng X·∫øp H·∫°ng AI
                        <button onclick="toggleMethodology()"
                            class="ml-2 text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-200">‚ùì
                            C√°ch t√≠nh ƒëi·ªÉm</button>
                    </h2>
                    <div class="text-xs text-slate-500 mt-2 flex gap-4 font-medium flex-wrap items-center">
                        <span
                            class="flex items-center gap-1 bg-green-50 px-2 py-1 rounded border border-green-200"><span
                                class="w-2 h-2 rounded-full bg-green-500"></span> MUA M·∫†NH (‚â•80)</span>
                        <span
                            class="flex items-center gap-1 bg-amber-50 px-2 py-1 rounded border border-amber-200"><span
                                class="w-2 h-2 rounded-full bg-amber-500"></span> THEO D√ïI (60-79)</span>
                        <span
                            class="flex items-center gap-1 bg-slate-50 px-2 py-1 rounded border border-slate-200"><span
                                class="w-2 h-2 rounded-full bg-slate-400"></span> CH·ªú (<60)< /span>
                                <span class="border-l border-slate-300 pl-4 ml-2 text-indigo-600 font-semibold">üí° Click
                                    v√†o d√≤ng ƒë·ªÉ xem chi ti·∫øt!</span>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <span id="ai-loading" class="text-xs font-medium text-slate-500 hidden flex items-center gap-1">
                        <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        ƒêang qu√©t...
                    </span>
                    <button onclick="fetchQuantSignals(1)"
                        class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold shadow-lg shadow-indigo-200 transition-all flex items-center gap-2 transform hover:scale-105 active:scale-95">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Qu√©t M√£ (Trang 1)
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-white text-xs text-slate-500 uppercase tracking-wider border-b border-slate-200">
                            <th class="px-6 py-4 font-bold text-center w-16 bg-slate-50/50">#</th>
                            <th class="px-6 py-4 font-bold">M√£ CP</th>
                            <th class="px-6 py-4 font-bold w-64">AI Score</th>
                            <th class="px-6 py-4 font-bold hidden md:table-cell text-center">FA / TA</th>
                            <th class="px-6 py-4 font-bold text-center">T√≠n Hi·ªáu</th>
                            <th class="px-6 py-4 font-bold w-1/3">L√Ω Do (Reasoning)</th>
                            <th class="px-6 py-4 font-bold text-center">Chart</th>
                        </tr>
                    </thead>
                    <tbody id="ai-ranking-body" class="divide-y divide-slate-100 text-sm bg-white">
                        <tr>
                            <td colspan="7" class="px-6 py-24 text-center text-slate-400">
                                <div class="flex flex-col items-center">
                                    <div
                                        class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mb-4 text-indigo-200">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                            </path>
                                        </svg>
                                    </div>
                                    <p class="text-lg font-medium text-slate-600">S·∫µn s√†ng ph√¢n t√≠ch (Ch·∫ø ƒë·ªô Ph√¢n trang)
                                    </p>
                                    <p class="text-sm mt-2 text-slate-400 max-w-md mx-auto">M·ªói l·∫ßn qu√©t 20 m√£ ƒë·ªÉ gi·∫£m
                                        t·∫£i API v√† tƒÉng t·ªëc ƒë·ªô.</p>
                                    <button onclick="fetchQuantSignals(1)"
                                        class="mt-6 text-indigo-600 font-semibold hover:underline">B·∫Øt ƒë·∫ßu qu√©t
                                        &rarr;</button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-center items-center gap-4">
                <button onclick="changePage(-1)"
                    class="px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-100 text-sm text-slate-600 disabled:opacity-50"
                    id="btn-prev">
                    &larr; Trang Tr∆∞·ªõc
                </button>
                <span id="page-display" class="text-sm font-bold text-slate-700">Trang 1 / 5</span>
                <button onclick="changePage(1)"
                    class="px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-100 text-sm text-slate-600 disabled:opacity-50"
                    id="btn-next">
                    Trang Sau &rarr;
                </button>
            </div>

            <div
                class="px-6 py-2 bg-slate-50 text-xs text-slate-400 flex justify-between items-center border-t border-slate-100">
                <span>D·ªØ li·ªáu t·ª´ API VNStock.</span>
                <span id="scan-time"></span>
            </div>
        </div>
    </main>

    <!-- Chart Modal -->
    <div id="chart-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/75 backdrop-blur-sm transition-opacity" onclick="closeChartModal()">
        </div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div
                    class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-5xl">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                            <h3 class="text-xl font-bold leading-6 text-slate-900 mb-4 flex justify-between"
                                id="modal-title">Bi·ªÉu ƒë·ªì k·ªπ thu·∫≠t</h3>
                            <div
                                class="w-full bg-slate-50 rounded-lg overflow-hidden border border-slate-200 min-h-[500px] flex items-center justify-center relative">
                                <div id="chart-loading"
                                    class="absolute inset-0 flex items-center justify-center bg-slate-50 z-10 hidden">
                                    <svg class="w-8 h-8 animate-spin text-indigo-500" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor"
                                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                        </path>
                                    </svg>
                                </div>
                                <img id="modal-chart-img" src="" alt="Technical Chart"
                                    class="w-full h-auto object-contain">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Methodology Modal -->
    <div id="methodology-modal" class="fixed inset-0 z-50 hidden" role="dialog">
        <div class="fixed inset-0 bg-slate-900/75 backdrop-blur-sm" onclick="toggleMethodology()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white">
                    <h3 class="text-xl font-bold text-slate-800">üìä Ph∆∞∆°ng Ph√°p T√≠nh ƒêi·ªÉm AI</h3>
                    <button onclick="toggleMethodology()"
                        class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                <div class="p-6 space-y-6 text-sm text-slate-700">
                    <p class="text-base">H·ªá th·ªëng AI c·ªßa ch√∫ng t√¥i ch·∫•m ƒëi·ªÉm m·ªói c·ªï phi·∫øu tr√™n thang 100 ƒëi·ªÉm, d·ª±a tr√™n
                        2 nh√≥m ti√™u ch√≠:</p>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-bold text-blue-800 text-lg mb-3">üè¢ PH√ÇN T√çCH C∆† B·∫¢N (FA) - 40 ƒêi·ªÉm</h4>
                        <ul class="space-y-2">
                            <li class="flex justify-between"><span>üìà <b>ƒê·ªãnh gi√° h·∫•p d·∫´n</b>: P/E th·∫•p h∆°n 90% trung v·ªã
                                    ng√†nh</span><span class="font-mono bg-blue-100 px-2 rounded">10 ƒë</span></li>
                            <li class="flex justify-between"><span>üöÄ <b>TƒÉng tr∆∞·ªüng m·∫°nh</b>: L·ª£i nhu·∫≠n >15% V√Ä Doanh
                                    thu >10% YoY</span><span class="font-mono bg-blue-100 px-2 rounded">10 ƒë</span></li>
                            <li class="flex justify-between"><span>üí∞ <b>Bi√™n l·ª£i nhu·∫≠n c·∫£i thi·ªán</b>: Bi√™n g·ªôp tƒÉng >5%
                                    YoY</span><span class="font-mono bg-blue-100 px-2 rounded">10 ƒë</span></li>
                            <li class="flex justify-between"><span>üè¶ <b>T√†i ch√≠nh l√†nh m·∫°nh</b>: T·ª∑ l·ªá N·ª£/V·ªën CSH <
                                        0.8</span><span class="font-mono bg-blue-100 px-2 rounded">10 ƒë</span></li>
                        </ul>
                    </div>

                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <h4 class="font-bold text-purple-800 text-lg mb-3">üìâ PH√ÇN T√çCH K·ª∏ THU·∫¨T (TA) - 60 ƒêi·ªÉm</h4>
                        <ul class="space-y-2">
                            <li class="flex justify-between"><span>üìä <b>Xu h∆∞·ªõng (Ichimoku)</b>: Gi√° tr√™n ƒë∆∞·ªùng
                                    Kijun-sen & Tenkan > Kijun</span><span
                                    class="font-mono bg-purple-100 px-2 rounded">15 ƒë</span></li>
                            <li class="flex justify-between"><span>‚ö° <b>ƒê·ªông l·ª±c (MACD)</b>: ƒê∆∞·ªùng MACD c·∫Øt l√™n Signal +
                                    Histogram d∆∞∆°ng</span><span class="font-mono bg-purple-100 px-2 rounded">15 ƒë</span>
                            </li>
                            <li class="flex justify-between"><span>üéØ <b>RSI</b>: Trong v√πng t√≠ch l≈©y (45-65) ho·∫∑c qu√°
                                    b√°n (<30)< /span><span class="font-mono bg-purple-100 px-2 rounded">15 ƒë</span></li>
                            <li class="flex justify-between"><span>üì¶ <b>Kh·ªëi l∆∞·ª£ng (VSA)</b>: Volume ƒë·ªôt bi·∫øn + N·∫øn
                                    tƒÉng r·ªông</span><span class="font-mono bg-purple-100 px-2 rounded">15 ƒë</span></li>
                        </ul>
                    </div>

                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="font-bold text-green-800">üèÜ K·∫øt Lu·∫≠n</h4>
                        <ul class="mt-2 space-y-1">
                            <li><span
                                    class="inline-block w-24 bg-green-500 text-white px-2 py-0.5 rounded text-center font-bold">MUA
                                    M·∫†NH</span> ƒêi·ªÉm ‚â• 80: C·ªï phi·∫øu ch·∫•t l∆∞·ª£ng cao, t√≠n hi·ªáu k·ªπ thu·∫≠t m·∫°nh</li>
                            <li><span
                                    class="inline-block w-24 bg-amber-400 text-amber-900 px-2 py-0.5 rounded text-center font-bold">THEO
                                    D√ïI</span> ƒêi·ªÉm 60-79: Ti·ªÅm nƒÉng, c·∫ßn theo d√µi th√™m ƒëi·ªÉm v√†o</li>
                            <li><span
                                    class="inline-block w-24 bg-slate-300 text-slate-700 px-2 py-0.5 rounded text-center font-bold">CH·ªú</span>
                                ƒêi·ªÉm < 60: Ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán, n√™n ch·ªù t√≠n hi·ªáu r√µ h∆°n</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Score Detail Modal -->
    <div id="score-detail-modal" class="fixed inset-0 z-50 hidden" role="dialog">
        <div class="fixed inset-0 bg-slate-900/75 backdrop-blur-sm" onclick="closeDetailModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full">
                <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                    <h3 id="detail-modal-title" class="text-xl font-bold text-slate-800">Chi Ti·∫øt ƒêi·ªÉm</h3>
                    <button onclick="closeDetailModal()"
                        class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                <div id="detail-modal-content" class="p-5 space-y-4">
                    <!-- Content injected by JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentPage = 1;
        const totalPages = 5;

        // Auto Load on Start
        window.addEventListener('load', () => {
            // fetchQuantSignals(1); // Manual trigger preferred
            updatePaginationUI();
        });

        async function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                fetchQuantSignals(newPage);
            }
        }

        async function fetchQuantSignals(page = 1) {
            currentPage = page;
            updatePaginationUI();

            const tableBody = document.getElementById('ai-ranking-body');
            const loading = document.getElementById('ai-loading');

            loading.classList.remove('hidden');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-24 text-center text-slate-400">
                        <div class="flex flex-col items-center animate-pulse">
                            <span class="text-3xl mb-4">ü§ñ</span>
                            <p class="text-lg font-medium text-slate-600">AI ƒëang qu√©t Trang ${page}...</p>
                            <p class="text-sm mt-1 text-slate-400">ƒêang t·∫£i 20 m√£.</p>
                        </div>
                    </td>
                </tr>`;

            try {
                // Fetch 20 stocks per page
                const response = await fetch(`${API_BASE}/api/screener/quant?limit=20&page=${page}`);
                const res = await response.json();

                // If API returns {"count": N, "data": []}
                const data = res.data || res; // Handle both formats if changed

                renderQuantSignals(data);
            } catch (error) {
                console.error("Error:", error);
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-red-500">L·ªói k·∫øt n·ªëi ho·∫∑c API qu√° t·∫£i. Vui l√≤ng th·ª≠ l·∫°i sau 30s.</td></tr>`;
            } finally {
                loading.classList.add('hidden');
            }
        }

        function updatePaginationUI() {
            document.getElementById('page-display').textContent = `Trang ${currentPage} / ${totalPages}`;
            document.getElementById('btn-prev').disabled = currentPage === 1;
            document.getElementById('btn-next').disabled = currentPage === totalPages;
        }

        function renderQuantSignals(data) {
            const tbody = document.getElementById('ai-ranking-body');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-slate-400">Kh√¥ng c√≥ d·ªØ li·ªáu tr√™n trang n√†y.</td></tr>';
                return;
            }

            // Cache data for detail modal
            data.forEach(item => {
                stockDataCache[item.symbol] = item;
            });

            tbody.innerHTML = data.map((item, index) => {
                const globalIndex = (currentPage - 1) * 20 + index + 1;
                const score = item.total_score;
                const badgeColor = score >= 80 ? 'text-green-600 bg-green-50 border-green-200' :
                    score >= 60 ? 'text-amber-600 bg-amber-50 border-amber-200' : 'text-slate-500 bg-slate-50 border-slate-100';

                const barColor = score >= 80 ? 'bg-green-500' : score >= 60 ? 'bg-amber-500' : 'bg-slate-300';

                const signalText = item.signal || "CH·ªú";
                // Vietnamese keywords: MUA = Buy (Green), B√ÅN = Sell (Red), CH·ªú/THEO D√ïI = Wait (Gray/Yellow)
                const signalStyle = signalText.includes('MUA') ? 'bg-green-500 text-white font-bold shadow-lg shadow-green-200' :
                    signalText.includes('B√ÅN') ? 'bg-red-500 text-white font-bold shadow-lg shadow-red-200' :
                        signalText.includes('THEO') ? 'bg-amber-400 text-amber-900 font-semibold' : 'bg-slate-200 text-slate-600';

                // Format chart url
                let chartUrl = item.chart_url;
                if (chartUrl && !chartUrl.startsWith('http')) {
                    // Assume relative path
                    // Ensure leading slash
                    if (!chartUrl.startsWith('/')) chartUrl = '/' + chartUrl;
                    chartUrl = API_BASE + chartUrl;
                }

                return `
                <tr onclick="showScoreDetail('${item.symbol}')" class="hover:bg-indigo-50 transition-colors cursor-pointer group border-b border-slate-50 last:border-0 relative">
                    <td class="px-6 py-4 text-center font-bold text-slate-400 bg-slate-50/30 italic">#${globalIndex}</td>
                    
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-800 text-lg">${item.symbol}</div>
                        <div class="text-xs text-slate-400">HOSE</div>
                    </td>
                    
                    <td class="px-6 py-4">
                         <div class="flex items-center justify-between mb-1.5 w-full max-w-[200px]">
                            <span class="text-sm font-extrabold ${badgeColor} px-2 py-0.5 rounded border">${score}/100</span>
                            <span class="text-xs text-slate-400">FA:${item.score_fa || '-'} | TA:${item.score_ta || '-'}</span>
                         </div>
                         <div class="w-full max-w-[200px] bg-slate-100 rounded-full h-2 overflow-hidden">
                             <div class="h-full rounded-full ${barColor} transition-all duration-1000 ease-out" style="width: ${score}%"></div>
                         </div>
                    </td>
                    
                    <td class="px-6 py-4 text-center hidden md:table-cell">
                        <div class="text-xs font-mono text-slate-500">
                            <div>FA: <b class="${(item.score_fa || 0) >= 20 ? 'text-emerald-600' : 'text-slate-600'}">${item.score_fa || 0}/40</b></div>
                            <div class="mt-1">TA: <b class="${(item.score_ta || 0) >= 40 ? 'text-blue-600' : 'text-slate-600'}">${item.score_ta || 0}/60</b></div>
                        </div>
                    </td>

                    <td class="px-6 py-4 text-center">
                        <span class="px-3 py-1 rounded-lg text-xs font-bold ${signalStyle}">${signalText}</span>
                    </td>
                    
                    <td class="px-6 py-4">
                        <p class="text-sm text-slate-600 italic leading-relaxed line-clamp-2" title="${item.ai_reasoning || ''}">
                            "${item.ai_reasoning || 'ƒêang theo d√µi'}"
                        </p>
                    </td>
                    
                    <td class="px-6 py-4 text-center">
                        ${item.chart_url ?
                        `<button onclick="showChart('${chartUrl}', '${item.symbol} - Analysis')" class="text-indigo-600 hover:text-indigo-800 bg-indigo-50 hover:bg-indigo-100 p-2 rounded-lg transition-colors border border-indigo-100">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/></svg>
                        </button>` :
                        `<span class="text-slate-300 pointer-events-none opacity-50"><svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg></span>`
                    }
                    </td>
                </tr>
                `;
            }).join('');

            document.getElementById('scan-time').textContent = `C·∫≠p nh·∫≠t: ${new Date().toLocaleTimeString('vi-VN')}`;
        }

        // Modal Logic
        function showChart(url, title) {
            const modal = document.getElementById('chart-modal');
            const img = document.getElementById('modal-chart-img');
            const tit = document.getElementById('modal-title');
            tit.textContent = title;
            img.src = url;
            modal.classList.remove('hidden');
        }
        function closeChartModal() {
            document.getElementById('chart-modal').classList.add('hidden');
        }

        // Methodology Modal
        function toggleMethodology() {
            document.getElementById('methodology-modal').classList.toggle('hidden');
        }

        // Score Detail Modal
        let stockDataCache = {};

        function showScoreDetail(symbol) {
            const item = stockDataCache[symbol];
            if (!item) return;

            document.getElementById('detail-modal-title').textContent = `üìä Chi Ti·∫øt ƒêi·ªÉm: ${symbol}`;

            const fa = item.fa_detail || {};
            const ta = item.ta_detail || {};

            const renderRow = (name, obj) => {
                if (!obj || !obj.max) return '';
                const pct = (obj.score / obj.max * 100).toFixed(0);
                const color = obj.score === obj.max ? 'bg-green-500' : obj.score > 0 ? 'bg-amber-400' : 'bg-slate-200';
                return `
                    <div class="flex items-center justify-between py-2 border-b border-slate-100">
                        <div class="text-sm text-slate-700">${name}</div>
                        <div class="flex items-center gap-2">
                            <div class="w-24 bg-slate-100 rounded-full h-2"><div class="h-2 rounded-full ${color}" style="width:${pct}%"></div></div>
                            <span class="text-sm font-mono font-bold ${obj.score > 0 ? 'text-green-600' : 'text-slate-400'}">${obj.score}/${obj.max}</span>
                        </div>
                    </div>
                    <div class="text-xs text-slate-400 mb-2">${obj.desc || ''}</div>
                `;
            };

            const html = `
                <div class="mb-4 p-4 rounded-lg ${item.total_score >= 80 ? 'bg-green-50 border border-green-200' : item.total_score >= 60 ? 'bg-amber-50 border border-amber-200' : 'bg-slate-50 border border-slate-200'}">
                    <div class="text-center">
                        <div class="text-4xl font-black ${item.total_score >= 80 ? 'text-green-600' : item.total_score >= 60 ? 'text-amber-600' : 'text-slate-500'}">${item.total_score}/100</div>
                        <div class="text-sm font-bold mt-1">${item.signal}</div>
                    </div>
                </div>
                
                <div class="bg-blue-50 rounded-lg p-3 mb-3">
                    <div class="font-bold text-blue-800 mb-2">üè¢ Ph√¢n T√≠ch C∆° B·∫£n (FA): ${item.score_fa || 0}/40</div>
                    ${renderRow('ƒê·ªãnh gi√° (P/E)', fa.valuation)}
                    ${renderRow('TƒÉng tr∆∞·ªüng', fa.growth)}
                    ${renderRow('Bi√™n l·ª£i nhu·∫≠n', fa.margin)}
                    ${renderRow('S·ª©c kh·ªèe t√†i ch√≠nh', fa.health)}
                </div>
                
                <div class="bg-purple-50 rounded-lg p-3">
                    <div class="font-bold text-purple-800 mb-2">üìâ Ph√¢n T√≠ch K·ªπ Thu·∫≠t (TA): ${item.score_ta || 0}/60</div>
                    ${renderRow('Xu h∆∞·ªõng (Ichimoku)', ta.trend)}
                    ${renderRow('ƒê·ªông l·ª±c (MACD)', ta.momentum)}
                    ${renderRow('RSI', ta.rsi)}
                    ${renderRow('Kh·ªëi l∆∞·ª£ng (VSA)', ta.volume)}
                </div>
                
                <div class="mt-4 p-3 bg-slate-50 rounded-lg text-sm text-slate-600 italic">
                    <strong>L√Ω do:</strong> ${item.ai_reasoning || 'ƒêang ph√¢n t√≠ch...'}
                </div>
            `;

            document.getElementById('detail-modal-content').innerHTML = html;
            document.getElementById('score-detail-modal').classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('score-detail-modal').classList.add('hidden');
        }
    </script>
</body>

</html>